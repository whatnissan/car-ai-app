<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Auto Troubleshoot AI</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}body{font-family:system-ui;background:#1e293b;color:#fff;min-height:100vh;display:flex;flex-direction:column;align-items:center;padding:2rem}.header{text-align:center;margin-bottom:2rem}.header h1{font-size:2rem;color:#f97316}.header p{color:#94a3b8;font-size:0.9rem;margin-top:0.5rem}.car-info{width:100%;max-width:800px;background:#334155;border-radius:1rem;padding:1.5rem;margin-bottom:1rem}.car-info-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:1rem;margin-bottom:1rem}.car-info input,.car-info select{width:100%;padding:0.75rem;border-radius:0.5rem;border:none;background:#475569;color:#fff;font-size:1rem}.car-info select{cursor:pointer}.car-info button{width:100%;padding:0.75rem;background:#10b981;color:#fff;border:none;border-radius:0.5rem;cursor:pointer;font-weight:600}.chat{width:100%;max-width:800px;background:#334155;border-radius:1rem;padding:1.5rem;margin-bottom:1rem;min-height:400px;max-height:500px;overflow-y:auto}.msg{margin:1rem 0;padding:1rem;border-radius:0.5rem}.msg.user{background:#f97316;margin-left:auto;max-width:80%}.msg.assistant{background:#475569;max-width:90%}.mermaid{background:#fff;padding:1rem;border-radius:0.5rem;margin:1rem 0}.input-box{width:100%;max-width:800px;display:flex;gap:0.5rem}#inp{flex:1;padding:1rem;border-radius:0.5rem;border:none;background:#334155;color:#fff;font-size:1rem}#btn{padding:1rem 2rem;background:#f97316;color:#fff;border:none;border-radius:0.5rem;cursor:pointer;font-weight:600}.welcome{text-align:center;color:#94a3b8;padding:2rem}.car-badge{background:#10b981;color:#fff;padding:0.5rem 1rem;border-radius:0.5rem;margin-bottom:1rem;font-weight:600}
    </style>
</head>
<body>
    <div class="header">
        <h1>üöó Auto Troubleshoot AI</h1>
        <p>üîç With diagram generation!</p>
    </div>
    
    <div class="car-info" id="carInfoSection">
        <h3 style="margin-bottom:1rem;color:#f97316">Enter Your Vehicle Info</h3>
        <div class="car-info-grid">
            <input type="number" id="year" placeholder="Year" min="1990" max="2025">
            <select id="make"><option value="">Select Make</option></select>
            <select id="model"><option value="">Select Model</option></select>
        </div>
        <button id="setCarBtn">Start Diagnosis</button>
    </div>
    
    <div class="chat" id="chat" style="display:none">
        <div class="welcome"><h2>Welcome!</h2><p>Ask for wiring diagrams and I'll create visual diagrams!</p></div>
    </div>
    
    <div class="input-box" id="inputBox" style="display:none">
        <input type="text" id="inp" placeholder="e.g., 'Show me rear window wiring diagram'">
        <button id="btn">Send</button>
    </div>
    
    <script>
        mermaid.initialize({ startOnLoad: true, theme: 'dark' });
        
        const carData = {
            "Honda": ["Accord", "Civic", "CR-V", "Fit", "HR-V", "Odyssey", "Pilot", "Ridgeline"]
        };
        
        const makeSelect = document.getElementById('make');
        const modelSelect = document.getElementById('model');
        const yearInput = document.getElementById('year');
        const setCarBtn = document.getElementById('setCarBtn');
        const carInfoSection = document.getElementById('carInfoSection');
        const chatSection = document.getElementById('chat');
        const inputBox = document.getElementById('inputBox');
        const c = document.getElementById('chat');
        const i = document.getElementById('inp');
        const b = document.getElementById('btn');
        
        let m = [];
        let carInfo = null;
        
        Object.keys(carData).forEach(make => {
            const option = document.createElement('option');
            option.value = make;
            option.textContent = make;
            makeSelect.appendChild(option);
        });
        
        makeSelect.onchange = function() {
            modelSelect.innerHTML = '<option value="">Select Model</option>';
            if (this.value) {
                carData[this.value].forEach(model => {
                    const option = document.createElement('option');
                    option.value = model;
                    option.textContent = model;
                    modelSelect.appendChild(option);
                });
            }
        };
        
        setCarBtn.onclick = function() {
            const year = yearInput.value.trim();
            const make = makeSelect.value;
            const model = modelSelect.value;
            
            if (!year || !make || !model) {
                alert('Please fill in all vehicle information');
                return;
            }
            
            carInfo = {year, make, model};
            carInfoSection.style.display = 'none';
            chatSection.style.display = 'block';
            inputBox.style.display = 'flex';
            
            const badge = document.createElement('div');
            badge.className = 'car-badge';
            badge.textContent = year + ' ' + make + ' ' + model;
            c.insertBefore(badge, c.firstChild);
            i.focus();
        };
        
        function renderMermaid(text) {
            const mermaidRegex = /```mermaid([\s\S]*?)```/g;
            let match;
            let lastIndex = 0;
            const parts = [];
            
            while ((match = mermaidRegex.exec(text)) !== null) {
                if (match.index > lastIndex) {
                    parts.push({ type: 'text', content: text.substring(lastIndex, match.index) });
                }
                parts.push({ type: 'mermaid', content: match[1].trim() });
                lastIndex = match.index + match[0].length;
            }
            
            if (lastIndex < text.length) {
                parts.push({ type: 'text', content: text.substring(lastIndex) });
            }
            
            return parts.length > 0 ? parts : [{ type: 'text', content: text }];
        }
        
        function add(r, t) {
            const d = document.createElement('div');
            d.className = 'msg ' + r;
            
            const parts = renderMermaid(t);
            parts.forEach((part, idx) => {
                if (part.type === 'mermaid') {
                    const mermaidDiv = document.createElement('div');
                    mermaidDiv.className = 'mermaid';
                    mermaidDiv.textContent = part.content;
                    d.appendChild(mermaidDiv);
                    setTimeout(() => mermaid.run({ nodes: [mermaidDiv] }), 100);
                } else {
                    const textDiv = document.createElement('div');
                    textDiv.style.whiteSpace = 'pre-wrap';
                    textDiv.textContent = part.content;
                    d.appendChild(textDiv);
                }
            });
            
            const w = c.querySelector('.welcome');
            if (w) w.remove();
            c.appendChild(d);
            c.scrollTop = c.scrollHeight;
        }
        
        async function send() {
            const t = i.value.trim();
            if (!t) return;
            
            i.value = '';
            b.disabled = true;
            
            let messageContent = t;
            if (m.length === 0 && carInfo) {
                messageContent = 'I have a ' + carInfo.year + ' ' + carInfo.make + ' ' + carInfo.model + '. ' + t;
            }
            
            m.push({role: 'user', content: messageContent});
            add('user', t);
            
            try {
                const r = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({messages: m, car_info: carInfo})
                });
                const d = await r.json();
                if (d.success) {
                    m.push({role: 'assistant', content: d.message});
                    add('assistant', d.message);
                } else {
                    add('assistant', 'Error: ' + (d.error || 'Unknown error'));
                }
            } catch (e) {
                add('assistant', 'Connection error');
            }
            
            b.disabled = false;
            i.focus();
        }
        
        b.onclick = send;
        i.onkeypress = e => { if (e.key === 'Enter') send(); };
    </script>
</body>
</html>